<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Multi-arm causal forest (experimental) — multi_arm_causal_forest • grf</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



  
  <script src="../extra.js"></script>

<meta property="og:title" content="Multi-arm causal forest (experimental) — multi_arm_causal_forest" />
<meta property="og:description" content="Trains a causal forest that can be used to estimate
conditional average treatment effects tau_k(X). When
the treatment assignment W is {1, ..., K} and unconfounded,
we have tau_k(X) = E[Y(k) - Y(1) | X = x] where Y(k) and
Y(1) are potential outcomes corresponding to the treatment
state for arm k and the baseline arm 1." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/categorical_inputs.html">Categorical inputs</a>
    </li>
    <li>
      <a href="../articles/ci_and_num.trees.html">Confidence intervals and the number of trees</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning</a>
    </li>
    <li>
      <a href="../articles/sample_weighting_examples.html">Sample weighting</a>
    </li>
    <li>
      <a href="../articles/visualize_tree.html">Visualize trees</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Multi-arm causal forest (experimental)</h1>
    <small class="dont-index">Source: <a href='https://github.com/grf-labs/grf/blob/master/R/multi_arm_causal_forest.R'><code>R/multi_arm_causal_forest.R</code></a></small>
    <div class="hidden name"><code>multi_arm_causal_forest.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Trains a causal forest that can be used to estimate
conditional average treatment effects tau_k(X). When
the treatment assignment W is {1, ..., K} and unconfounded,
we have tau_k(X) = E[Y(k) - Y(1) | X = x] where Y(k) and
Y(1) are potential outcomes corresponding to the treatment
state for arm k and the baseline arm 1.</p>
    </div>

    <pre class="usage"><span class='fu'>multi_arm_causal_forest</span>(
  <span class='no'>X</span>,
  <span class='no'>Y</span>,
  <span class='no'>W</span>,
  <span class='kw'>Y.hat</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>W.hat</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>num.trees</span> <span class='kw'>=</span> <span class='fl'>2000</span>,
  <span class='kw'>sample.weights</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>clusters</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>equalize.cluster.weights</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>sample.fraction</span> <span class='kw'>=</span> <span class='fl'>0.5</span>,
  <span class='kw'>mtry</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>min</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/Round.html'>ceiling</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span>(<span class='no'>X</span>)) + <span class='fl'>20</span>), <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>ncol</a></span>(<span class='no'>X</span>)),
  <span class='kw'>min.node.size</span> <span class='kw'>=</span> <span class='fl'>5</span>,
  <span class='kw'>honesty</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>honesty.fraction</span> <span class='kw'>=</span> <span class='fl'>0.5</span>,
  <span class='kw'>honesty.prune.leaves</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>alpha</span> <span class='kw'>=</span> <span class='fl'>0.05</span>,
  <span class='kw'>imbalance.penalty</span> <span class='kw'>=</span> <span class='fl'>0</span>,
  <span class='kw'>stabilize.splits</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>ci.group.size</span> <span class='kw'>=</span> <span class='fl'>2</span>,
  <span class='kw'>compute.oob.predictions</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>num.threads</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>seed</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span>(<span class='fl'>1</span>, <span class='fl'>0</span>, <span class='no'>.Machine</span>$<span class='no'>integer.max</span>)
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>X</th>
      <td><p>The covariates used in the causal regression.</p></td>
    </tr>
    <tr>
      <th>Y</th>
      <td><p>The outcome (must be a numeric vector or matrix [one column per outcome] with no NAs).</p></td>
    </tr>
    <tr>
      <th>W</th>
      <td><p>The treatment assignment (must be a factor vector with no NAs). The reference treatment
is set to the first treatment according to the ordinality of the factors, this can be changed
with the `relevel` function in R.</p></td>
    </tr>
    <tr>
      <th>Y.hat</th>
      <td><p>Estimates of the expected responses E[Y | Xi], marginalizing
over treatment. If Y.hat = NULL, these are estimated using
a separate multi-task regression forest. Default is NULL.</p></td>
    </tr>
    <tr>
      <th>W.hat</th>
      <td><p>Matrix with estimates of the treatment propensities E[Wk | Xi].
If W.hat = NULL, these are estimated using a probability forest.</p></td>
    </tr>
    <tr>
      <th>num.trees</th>
      <td><p>Number of trees grown in the forest. Note: Getting accurate
confidence intervals generally requires more trees than
getting accurate predictions. Default is 2000.</p></td>
    </tr>
    <tr>
      <th>sample.weights</th>
      <td><p>Weights given to each sample in estimation.
If NULL, each observation receives the same weight.
Note: To avoid introducing confounding, weights should be
independent of the potential outcomes given X. Default is NULL.</p></td>
    </tr>
    <tr>
      <th>clusters</th>
      <td><p>Vector of integers or factors specifying which cluster each observation corresponds to.
Default is NULL (ignored).</p></td>
    </tr>
    <tr>
      <th>equalize.cluster.weights</th>
      <td><p>If FALSE, each unit is given the same weight (so that bigger
clusters get more weight). If TRUE, each cluster is given equal weight in the forest. In this case,
during training, each tree uses the same number of observations from each drawn cluster: If the
smallest cluster has K units, then when we sample a cluster during training, we only give a random
K elements of the cluster to the tree-growing procedure. When estimating average treatment effects,
each observation is given weight 1/cluster size, so that the total weight of each cluster is the
same. Note that, if this argument is FALSE, sample weights may also be directly adjusted via the
sample.weights argument. If this argument is TRUE, sample.weights must be set to NULL. Default is
FALSE.</p></td>
    </tr>
    <tr>
      <th>sample.fraction</th>
      <td><p>Fraction of the data used to build each tree.
Note: If honesty = TRUE, these subsamples will
further be cut by a factor of honesty.fraction. Default is 0.5.</p></td>
    </tr>
    <tr>
      <th>mtry</th>
      <td><p>Number of variables tried for each split. Default is
\(\sqrt p + 20\) where p is the number of variables.</p></td>
    </tr>
    <tr>
      <th>min.node.size</th>
      <td><p>A target for the minimum number of observations in each tree leaf. Note that nodes
with size smaller than min.node.size can occur, as in the original randomForest package.
Default is 5.</p></td>
    </tr>
    <tr>
      <th>honesty</th>
      <td><p>Whether to use honest splitting (i.e., sub-sample splitting). Default is TRUE.
For a detailed description of honesty, honesty.fraction, honesty.prune.leaves, and recommendations for
parameter tuning, see the grf algorithm reference.</p></td>
    </tr>
    <tr>
      <th>honesty.fraction</th>
      <td><p>The fraction of data that will be used for determining splits if honesty = TRUE. Corresponds
to set J1 in the notation of the paper. Default is 0.5 (i.e. half of the data is used for
determining splits).</p></td>
    </tr>
    <tr>
      <th>honesty.prune.leaves</th>
      <td><p>If TRUE, prunes the estimation sample tree such that no leaves
are empty. If FALSE, keep the same tree as determined in the splits sample (if an empty leave is encountered, that
tree is skipped and does not contribute to the estimate). Setting this to FALSE may improve performance on
small/marginally powered data, but requires more trees (note: tuning does not adjust the number of trees).
Only applies if honesty is enabled. Default is TRUE.</p></td>
    </tr>
    <tr>
      <th>alpha</th>
      <td><p>A tuning parameter that controls the maximum imbalance of a split. Default is 0.05.</p></td>
    </tr>
    <tr>
      <th>imbalance.penalty</th>
      <td><p>A tuning parameter that controls how harshly imbalanced splits are penalized. Default is 0.</p></td>
    </tr>
    <tr>
      <th>stabilize.splits</th>
      <td><p>Whether or not the treatment should be taken into account when
determining the imbalance of a split. It is an exact extension of the single-arm constraints (detailed
in the causal forest algorithm reference) to multiple arms, where the constraints apply to each treatment arm independently.
Default is TRUE.</p></td>
    </tr>
    <tr>
      <th>ci.group.size</th>
      <td><p>The forest will grow ci.group.size trees on each subsample.
In order to provide confidence intervals, ci.group.size must
be at least 2. Default is 2. (Confidence intervals are
currently only supported for univariate outcomes Y).</p></td>
    </tr>
    <tr>
      <th>compute.oob.predictions</th>
      <td><p>Whether OOB predictions on training set should be precomputed. Default is TRUE.</p></td>
    </tr>
    <tr>
      <th>num.threads</th>
      <td><p>Number of threads used in training. By default, the number of threads is set
to the maximum hardware concurrency.</p></td>
    </tr>
    <tr>
      <th>seed</th>
      <td><p>The seed of the C++ random number generator.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A trained multi arm causal forest object.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This forest fits a multi-arm treatment estimate following the multivariate
extension of the "R-learner" suggested in Nie and Wager (2021), with kernel
weights derived by the GRF algortim (Athey, Tibshirani, and Wager, 2019).
In particular, with K arms, and W encoded as {0, 1}^(K-1), we estimate, for
a target sample x, and a chosen baseline arm:</p>
<p>\(\hat \tau(x) = argmin_{\tau} \left\{ \sum_{i=1}^{n}
\alpha_i (x) \left( Y_i - \hat m^{(-i)}(X_i) - c(x) -
\left\langle W_i - \hat e^{(-i)}(X_i), \,  \tau(X_i)  \right\rangle
\right)^2 \right\}\),</p>
<p>where the angle brackets indicates an inner product, e(X) = E[W | X = x] is
a (vector valued) generalized propensity score, and m(x) = E[Y | X = x].
The forest weights alpha(x) are derived from a generalized random forest
splitting on the vector-valued gradient of tau(x). (The intercept c(x)
is a nuisance parameter not directly estimated). By default, e(X) and
m(X) are estimated using two separate random forests, a probability forest
and regression forest respectively (optionally provided through the arguments
W.hat and Y.hat). The k-th element of tau(x) measures the conditional average
treatment effect of the k-th treatment arm at X = x for k = 1, ..., K-1.
The treatment effect for multiple outcomes can be estimated jointly (i.e. Y can
be vector-valued) - in which case the splitting rule takes into account
all outcomes simultaneously (specifically, we concatenate the gradient
vector for each outcome).</p>
<p>For a single treatment, this forest is equivalent to a causal forest, however,
they may produce different results due to differences in numerics.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Athey, Susan, Julie Tibshirani, and Stefan Wager. "Generalized Random Forests".
 Annals of Statistics, 47(2), 2019.</p>
<p>Nie, Xinkun, and Stefan Wager. "Quasi-Oracle Estimation of Heterogeneous Treatment Effects".
 Biometrika, 108(2), 2021.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># \donttest{</span>
<span class='co'># Train a multi arm causal forest.</span>
<span class='no'>n</span> <span class='kw'>&lt;-</span> <span class='fl'>500</span>
<span class='no'>p</span> <span class='kw'>&lt;-</span> <span class='fl'>10</span>
<span class='no'>X</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span> * <span class='no'>p</span>), <span class='no'>n</span>, <span class='no'>p</span>)
<span class='no'>W</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>as.factor</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"A"</span>, <span class='st'>"B"</span>, <span class='st'>"C"</span>), <span class='no'>n</span>, <span class='kw'>replace</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>))
<span class='no'>Y</span> <span class='kw'>&lt;-</span> <span class='no'>X</span>[, <span class='fl'>1</span>] + <span class='no'>X</span>[, <span class='fl'>2</span>] * (<span class='no'>W</span> <span class='kw'>==</span> <span class='st'>"B"</span>) - <span class='fl'>1.5</span> * <span class='no'>X</span>[, <span class='fl'>2</span>] * (<span class='no'>W</span> <span class='kw'>==</span> <span class='st'>"C"</span>) + <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span>)
<span class='no'>mc.forest</span> <span class='kw'>&lt;-</span> <span class='fu'>multi_arm_causal_forest</span>(<span class='no'>X</span>, <span class='no'>Y</span>, <span class='no'>W</span>)

<span class='co'># Predict contrasts (out-of-bag) using the forest.</span>
<span class='co'># By default, the first ordinal treatment is used as baseline ("A" in this example),</span>
<span class='co'># giving two contrasts tau_B = Y(B) - Y(A), tau_C = Y(C) - Y(A)</span>
<span class='no'>mc.pred</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span>(<span class='no'>mc.forest</span>)
<span class='co'># Fitting several outcomes jointly is supported, and the returned prediction array has</span>
<span class='co'># dimension [num.samples, num.contrasts, num.outcomes]. Since num.outcomes is one in</span>
<span class='co'># this example, we can `drop()` this singleton dimension using the `[,,]` shorthand.</span>
<span class='no'>tau.hat</span> <span class='kw'>&lt;-</span> <span class='no'>mc.pred</span>$<span class='no'>predictions</span>[,,]

<span class='fu'><a href='https://rdrr.io/r/base/plot.html'>plot</a></span>(<span class='no'>X</span>[, <span class='fl'>2</span>], <span class='no'>tau.hat</span>[, <span class='st'>"B - A"</span>], <span class='kw'>ylab</span> <span class='kw'>=</span> <span class='st'>"tau.contrast"</span>)</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span>(<span class='fl'>0</span>, <span class='fl'>1</span>, <span class='kw'>col</span> <span class='kw'>=</span> <span class='st'>"red"</span>)</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/points.html'>points</a></span>(<span class='no'>X</span>[, <span class='fl'>2</span>], <span class='no'>tau.hat</span>[, <span class='st'>"C - A"</span>], <span class='kw'>col</span> <span class='kw'>=</span> <span class='st'>"blue"</span>)</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/abline.html'>abline</a></span>(<span class='fl'>0</span>, -<span class='fl'>1.5</span>, <span class='kw'>col</span> <span class='kw'>=</span> <span class='st'>"red"</span>)</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/graphics/legend.html'>legend</a></span>(<span class='st'>"topleft"</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"B - A"</span>, <span class='st'>"C - A"</span>), <span class='kw'>col</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"black"</span>, <span class='st'>"blue"</span>), <span class='kw'>pch</span> <span class='kw'>=</span> <span class='fl'>19</span>)</div><div class='img'><img src='multi_arm_causal_forest-1.png' alt='' width='700' height='433' /></div><div class='input'>
<span class='co'># The average treatment effect of the arms with "A" as baseline.</span>
<span class='fu'><a href='average_treatment_effect.html'>average_treatment_effect</a></span>(<span class='no'>mc.forest</span>)</div><div class='output co'>#&gt;          estimate   std.err contrast outcome
#&gt; B - A  0.02875015 0.1197462    B - A     Y.1
#&gt; C - A -0.14652013 0.1355830    C - A     Y.1</div><div class='input'>
<span class='co'># The conditional response surfaces mu_k(X) for a single outcome can be reconstructed from</span>
<span class='co'># the contrasts tau_k(x), the treatment propensities e_k(x), and the conditional mean m(x).</span>
<span class='co'># Given treatment "A" as baseline we have:</span>
<span class='co'># m(x) := E[Y | X] = E[Y(A) | X] + E[W_B (Y(B) - Y(A))] + E[W_C (Y(C) - Y(A))]</span>
<span class='co'># which given unconfoundedness is equal to:</span>
<span class='co'># m(x) = mu(A, x) + e_B(x) tau_B(X) + e_C(x) tau_C(x)</span>
<span class='co'># Rearranging and plugging in the above expressions, we obtain the following estimates</span>
<span class='co'># * mu(A, x) = m(x) - e_B(x) tau_B(x) - e_C(x) tau_C(x)</span>
<span class='co'># * mu(B, x) = m(x) + (1 - e_B(x)) tau_B(x) - e_C(x) tau_C(x)</span>
<span class='co'># * mu(C, x) = m(x) - e_B(x) tau_B(x) + (1 - e_C(x)) tau_C(x)</span>
<span class='no'>Y.hat</span> <span class='kw'>&lt;-</span> <span class='no'>mc.forest</span>$<span class='no'>Y.hat</span>
<span class='no'>W.hat</span> <span class='kw'>&lt;-</span> <span class='no'>mc.forest</span>$<span class='no'>W.hat</span>

<span class='no'>muA</span> <span class='kw'>&lt;-</span> <span class='no'>Y.hat</span> - <span class='no'>W.hat</span>[, <span class='st'>"B"</span>] * <span class='no'>tau.hat</span>[, <span class='st'>"B - A"</span>] - <span class='no'>W.hat</span>[, <span class='st'>"C"</span>] * <span class='no'>tau.hat</span>[, <span class='st'>"C - A"</span>]
<span class='no'>muB</span> <span class='kw'>&lt;-</span> <span class='no'>Y.hat</span> + (<span class='fl'>1</span> - <span class='no'>W.hat</span>[, <span class='st'>"B"</span>]) * <span class='no'>tau.hat</span>[, <span class='st'>"B - A"</span>] - <span class='no'>W.hat</span>[, <span class='st'>"C"</span>] * <span class='no'>tau.hat</span>[, <span class='st'>"C - A"</span>]
<span class='no'>muC</span> <span class='kw'>&lt;-</span> <span class='no'>Y.hat</span> - <span class='no'>W.hat</span>[, <span class='st'>"B"</span>] * <span class='no'>tau.hat</span>[, <span class='st'>"B - A"</span>] + (<span class='fl'>1</span> - <span class='no'>W.hat</span>[, <span class='st'>"C"</span>]) * <span class='no'>tau.hat</span>[, <span class='st'>"C - A"</span>]

<span class='co'># These can also be obtained with some array manipulations.</span>
<span class='co'># (the first column is always the baseline arm)</span>
<span class='no'>Y.hat.baseline</span> <span class='kw'>&lt;-</span> <span class='no'>Y.hat</span> - <span class='fu'><a href='https://rdrr.io/r/base/colSums.html'>rowSums</a></span>(<span class='no'>W.hat</span>[, -<span class='fl'>1</span>, <span class='kw'>drop</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>] * <span class='no'>tau.hat</span>)
<span class='no'>mu.hat.matrix</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/cbind.html'>cbind</a></span>(<span class='no'>Y.hat.baseline</span>, <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='no'>Y.hat.baseline</span>) + <span class='no'>tau.hat</span>)
<span class='fu'><a href='https://rdrr.io/r/base/colnames.html'>colnames</a></span>(<span class='no'>mu.hat.matrix</span>) <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/levels.html'>levels</a></span>(<span class='no'>W</span>)
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span>(<span class='no'>mu.hat.matrix</span>)</div><div class='output co'>#&gt;                A          B          C
#&gt; [1,]  0.33408792  0.1160133  0.7284166
#&gt; [2,] -0.31983419  0.5215760 -2.1683454
#&gt; [3,]  1.06521425  0.9907741  1.3449928
#&gt; [4,]  0.05363935 -0.7165410  1.1511353
#&gt; [5,] -1.07160385 -1.8710761  0.1156056
#&gt; [6,] -1.26389423 -1.6890332 -0.3890184</div><div class='input'>
<span class='co'># The reference level for contrast prediction can be changed with `relevel`.</span>
<span class='co'># Fit and predict with treatment B as baseline:</span>
<span class='no'>W</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/relevel.html'>relevel</a></span>(<span class='no'>W</span>, <span class='kw'>ref</span> <span class='kw'>=</span> <span class='st'>"B"</span>)
<span class='no'>mc.forest.B</span> <span class='kw'>&lt;-</span> <span class='fu'>multi_arm_causal_forest</span>(<span class='no'>X</span>, <span class='no'>Y</span>, <span class='no'>W</span>)
<span class='co'># }</span></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


