<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Get doubly robust estimates of average treatment effects. — average_treatment_effect • grf</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



  
  <script src="../extra.js"></script>

<meta property="og:title" content="Get doubly robust estimates of average treatment effects. — average_treatment_effect" />
<meta property="og:description" content="In the case of a causal forest with binary treatment, we provide
estimates of one of the following:
The average treatment effect (target.sample = all): E[Y(1) - Y(0)]
The average treatment effect on the treated (target.sample = treated): E[Y(1) - Y(0) | Wi = 1]
The average treatment effect on the controls (target.sample = control): E[Y(1) - Y(0) | Wi = 0]
The overlap-weighted average treatment effect (target.sample = overlap):
  E[e(X) (1 - e(X)) (Y(1) - Y(0))] / E[e(X) (1 - e(X)), where e(x) = P[Wi = 1 | Xi = x].
This last estimand is recommended by Li, Morgan, and Zaslavsky (2018)
in case of poor overlap (i.e., when the propensities e(x) may be very close
to 0 or 1), as it doesn't involve dividing by estimated propensities." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/categorical_inputs.html">Categorical inputs</a>
    </li>
    <li>
      <a href="../articles/ci_and_num.trees.html">Confidence intervals and the number of trees</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning</a>
    </li>
    <li>
      <a href="../articles/sample_weighting_examples.html">Sample weighting</a>
    </li>
    <li>
      <a href="../articles/visualize_tree.html">Visualize trees</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Get doubly robust estimates of average treatment effects.</h1>
    <small class="dont-index">Source: <a href='https://github.com/grf-labs/grf/blob/master/R/average_treatment_effect.R'><code>R/average_treatment_effect.R</code></a></small>
    <div class="hidden name"><code>average_treatment_effect.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>In the case of a causal forest with binary treatment, we provide
estimates of one of the following:</p><ul>
<li><p>The average treatment effect (target.sample = all): E[Y(1) - Y(0)]</p></li>
<li><p>The average treatment effect on the treated (target.sample = treated): E[Y(1) - Y(0) | Wi = 1]</p></li>
<li><p>The average treatment effect on the controls (target.sample = control): E[Y(1) - Y(0) | Wi = 0]</p></li>
<li><p>The overlap-weighted average treatment effect (target.sample = overlap):
  E[e(X) (1 - e(X)) (Y(1) - Y(0))] / E[e(X) (1 - e(X)), where e(x) = P[Wi = 1 | Xi = x].</p></li>
</ul><p>This last estimand is recommended by Li, Morgan, and Zaslavsky (2018)
in case of poor overlap (i.e., when the propensities e(x) may be very close
to 0 or 1), as it doesn't involve dividing by estimated propensities.</p>
    </div>

    <pre class="usage"><span class='fu'>average_treatment_effect</span>(
  <span class='no'>forest</span>,
  <span class='kw'>target.sample</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"all"</span>, <span class='st'>"treated"</span>, <span class='st'>"control"</span>, <span class='st'>"overlap"</span>),
  <span class='kw'>method</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span>(<span class='st'>"AIPW"</span>, <span class='st'>"TMLE"</span>),
  <span class='kw'>subset</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>debiasing.weights</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>compliance.score</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>num.trees.for.weights</span> <span class='kw'>=</span> <span class='fl'>500</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>forest</th>
      <td><p>The trained forest.</p></td>
    </tr>
    <tr>
      <th>target.sample</th>
      <td><p>Which sample to aggregate treatment effects over.
Note: Options other than "all" are only currently implemented
for causal forests.</p></td>
    </tr>
    <tr>
      <th>method</th>
      <td><p>Method used for doubly robust inference. Can be either
augmented inverse-propensity weighting (AIPW), or
targeted maximum likelihood estimation (TMLE). Note:
TMLE is currently only implemented for causal forests with
a binary treatment.</p></td>
    </tr>
    <tr>
      <th>subset</th>
      <td><p>Specifies subset of the training examples over which we
estimate the ATE. WARNING: For valid statistical performance,
the subset should be defined only using features Xi, not using
the treatment Wi or the outcome Yi.</p></td>
    </tr>
    <tr>
      <th>debiasing.weights</th>
      <td><p>A vector of length n (or the subset length) of debiasing weights.
If NULL (default) these are obtained via the appropriate doubly robust score
construction, e.g., in the case of causal_forests with a binary treatment, they
are obtained via inverse-propensity weighting.</p></td>
    </tr>
    <tr>
      <th>compliance.score</th>
      <td><p>Only used with instrumental forests. An estimate of the causal
effect of Z on W, i.e., Delta(X) = E[W | X, Z = 1] - E[W | X, Z = 0],
which can then be used to produce debiasing.weights. If not provided,
this is estimated via an auxiliary causal forest.</p></td>
    </tr>
    <tr>
      <th>num.trees.for.weights</th>
      <td><p>In some cases (e.g., with causal forests with a continuous
treatment), we need to train auxiliary forests to learn debiasing weights.
This is the number of trees used for this task. Note: this argument is only
used when debiasing.weights = NULL.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>An estimate of the average treatment effect, along with standard error.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>In the case of a causal forest with continuous treatment, we provide estimates of the
average partial effect, i.e., E[Cov[W, Y | X] / Var[W | X]]. In the case of a binary treatment,
the average partial effect matches the average treatment effect. Computing the average partial
effect is somewhat more involved, as the relevant doubly robust scores require an estimate
of Var[Wi | Xi = x]. By default, we get such estimates by training an auxiliary forest;
however, these weights can also be passed manually by specifying debiasing.weights.</p>
<p>In the case of instrumental forests with a binary treatment, we provide an estimate
of the the Average (Conditional) Local Averate Treatment (ACLATE).
Specifically, given an outcome Y, treatment W and instrument Z, the (conditional) local
average treatment effect is tau(x) = Cov[Y, Z | X = x] / Cov[W, Z | X = x].
This is the quantity that is estimated with an instrumental forest.
It can be intepreted causally in various ways. Given a homogeneity
assumption, tau(x) is simply the CATE at x. When W is binary
and there are no "defiers", Imbens and Angrist (1994) show that tau(x) can
be interpreted as an average treatment effect on compliers. This function
provides and estimate of tau = E[tau(X)]. See Chernozhukov
et al. (2016) for a discussion, and Section 5.2 of Athey and Wager (2021)
for an example using forests.</p>
<p>If clusters are specified, then each unit gets equal weight by default. For
example, if there are 10 clusters with 1 unit each and per-cluster ATE = 1,
and there are 10 clusters with 19 units each and per-cluster ATE = 0, then
the overall ATE is 0.05 (additional sample.weights allow for custom
weighting). If equalize.cluster.weights = TRUE each cluster gets equal weight
and the overall ATE is 0.5.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Athey, Susan, and Stefan Wager. "Policy Learning With Observational Data."
            Econometrica 89.1 (2021): 133-161.</p>
<p>Chernozhukov, Victor, Juan Carlos Escanciano, Hidehiko Ichimura,
            Whitney K. Newey, and James M. Robins. "Locally robust semiparametric
            estimation." arXiv preprint arXiv:1608.00033, 2016.</p>
<p>Imbens, Guido W., and Joshua D. Angrist. "Identification and Estimation of
            Local Average Treatment Effects." Econometrica 62(2), 1994.</p>
<p>Li, Fan, Kari Lock Morgan, and Alan M. Zaslavsky.
            "Balancing covariates via propensity score weighting."
            Journal of the American Statistical Association 113(521), 2018.</p>
<p>Robins, James M., and Andrea Rotnitzky. "Semiparametric efficiency in
            multivariate regression models with missing data." Journal of the
            American Statistical Association 90(429), 1995.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># \donttest{</span>
<span class='co'># Train a causal forest.</span>
<span class='no'>n</span> <span class='kw'>&lt;-</span> <span class='fl'>50</span>
<span class='no'>p</span> <span class='kw'>&lt;-</span> <span class='fl'>10</span>
<span class='no'>X</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span> * <span class='no'>p</span>), <span class='no'>n</span>, <span class='no'>p</span>)
<span class='no'>W</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span>(<span class='no'>n</span>, <span class='fl'>1</span>, <span class='fl'>0.5</span>)
<span class='no'>Y</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>pmax</a></span>(<span class='no'>X</span>[, <span class='fl'>1</span>], <span class='fl'>0</span>) * <span class='no'>W</span> + <span class='no'>X</span>[, <span class='fl'>2</span>] + <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>pmin</a></span>(<span class='no'>X</span>[, <span class='fl'>3</span>], <span class='fl'>0</span>) + <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span>)
<span class='no'>c.forest</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='causal_forest.html'>causal_forest</a></span>(<span class='no'>X</span>, <span class='no'>Y</span>, <span class='no'>W</span>)

<span class='co'># Predict using the forest.</span>
<span class='no'>X.test</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span>(<span class='fl'>0</span>, <span class='fl'>101</span>, <span class='no'>p</span>)
<span class='no'>X.test</span>[, <span class='fl'>1</span>] <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span>(-<span class='fl'>2</span>, <span class='fl'>2</span>, <span class='kw'>length.out</span> <span class='kw'>=</span> <span class='fl'>101</span>)
<span class='no'>c.pred</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span>(<span class='no'>c.forest</span>, <span class='no'>X.test</span>)
<span class='co'># Estimate the conditional average treatment effect on the full sample (CATE).</span>
<span class='fu'>average_treatment_effect</span>(<span class='no'>c.forest</span>, <span class='kw'>target.sample</span> <span class='kw'>=</span> <span class='st'>"all"</span>)</div><div class='output co'>#&gt;    estimate     std.err 
#&gt; -0.09675011  0.40735444 </div><div class='input'>
<span class='co'># Estimate the conditional average treatment effect on the treated sample (CATT).</span>
<span class='co'># We don't expect much difference between the CATE and the CATT in this example,</span>
<span class='co'># since treatment assignment was randomized.</span>
<span class='fu'>average_treatment_effect</span>(<span class='no'>c.forest</span>, <span class='kw'>target.sample</span> <span class='kw'>=</span> <span class='st'>"treated"</span>)</div><div class='output co'>#&gt;    estimate     std.err 
#&gt; -0.06564791  0.40577566 </div><div class='input'>
<span class='co'># Estimate the conditional average treatment effect on samples with positive X[,1].</span>
<span class='fu'>average_treatment_effect</span>(<span class='no'>c.forest</span>, <span class='kw'>target.sample</span> <span class='kw'>=</span> <span class='st'>"all"</span>, <span class='kw'>subset</span> <span class='kw'>=</span> <span class='no'>X</span>[, <span class='fl'>1</span>] <span class='kw'>&gt;</span> <span class='fl'>0</span>)</div><div class='output co'>#&gt;  estimate   std.err 
#&gt; 0.6126443 0.5750878 </div><div class='input'>
<span class='co'># Example for causal forests with a continuous treatment.</span>
<span class='no'>n</span> <span class='kw'>&lt;-</span> <span class='fl'>2000</span>
<span class='no'>p</span> <span class='kw'>&lt;-</span> <span class='fl'>10</span>
<span class='no'>X</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span>(<span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span> * <span class='no'>p</span>), <span class='no'>n</span>, <span class='no'>p</span>)
<span class='no'>W</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Binomial.html'>rbinom</a></span>(<span class='no'>n</span>, <span class='fl'>1</span>, <span class='fl'>1</span> / (<span class='fl'>1</span> + <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span>(-<span class='no'>X</span>[, <span class='fl'>2</span>]))) + <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span>)
<span class='no'>Y</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>pmax</a></span>(<span class='no'>X</span>[, <span class='fl'>1</span>], <span class='fl'>0</span>) * <span class='no'>W</span> + <span class='no'>X</span>[, <span class='fl'>2</span>] + <span class='fu'><a href='https://rdrr.io/r/base/Extremes.html'>pmin</a></span>(<span class='no'>X</span>[, <span class='fl'>3</span>], <span class='fl'>0</span>) + <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span>(<span class='no'>n</span>)
<span class='no'>tau.forest</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='causal_forest.html'>causal_forest</a></span>(<span class='no'>X</span>, <span class='no'>Y</span>, <span class='no'>W</span>)
<span class='no'>tau.hat</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span>(<span class='no'>tau.forest</span>)
<span class='fu'>average_treatment_effect</span>(<span class='no'>tau.forest</span>)</div><div class='output co'>#&gt;   estimate    std.err 
#&gt; 0.41612850 0.02490991 </div><div class='input'><span class='fu'>average_treatment_effect</span>(<span class='no'>tau.forest</span>, <span class='kw'>subset</span> <span class='kw'>=</span> <span class='no'>X</span>[, <span class='fl'>1</span>] <span class='kw'>&gt;</span> <span class='fl'>0</span>)</div><div class='output co'>#&gt;   estimate    std.err 
#&gt; 0.78572565 0.03503522 </div><div class='input'># }

</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


