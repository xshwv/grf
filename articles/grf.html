<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to grf â€¢ grf</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><script src="../extra.js"></script><meta property="og:title" content="Introduction to grf">
<meta property="og:description" content="grf">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">grf</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/grf.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/categorical_inputs.html">Categorical inputs</a>
    </li>
    <li>
      <a href="../articles/ci_and_num.trees.html">Confidence intervals and the number of trees</a>
    </li>
    <li>
      <a href="../articles/muhats.html">Estimating conditional means</a>
    </li>
    <li>
      <a href="../articles/diagnostics.html">Evaluating a causal forest fit</a>
    </li>
    <li>
      <a href="../articles/llf.html">Local linear forests</a>
    </li>
    <li>
      <a href="../articles/policy_learning.html">Policy learning</a>
    </li>
    <li>
      <a href="../articles/sample_weighting_examples.html">Sample weighting</a>
    </li>
    <li>
      <a href="../articles/visualize_tree.html">Visualize trees</a>
    </li>
  </ul>
</li>
<li>
  <a href="../REFERENCE.html">Algorithm reference</a>
</li>
<li>
  <a href="../DEVELOPING.html">Developing</a>
</li>
<li>
  <a href="../CHANGELOG.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/grf-labs/grf">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to grf</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grf-labs/grf/blob/master/vignettes/grf.Rmd"><code>vignettes/grf.Rmd</code></a></small>
      <div class="hidden name"><code>grf.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">grf</span>)</pre></body></html></div>
<p>The following example demonstrates how to use GRF for heterogeneous treatment effect estimation. For examples of how to use types of forest, as for quantile regression and causal effect estimation using instrumental variables, please consult the R documentation on the relevant forest methods (quantile_forest, instrumental_forest, etc.).</p>
<p>Generate data and train a causal forest</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">2000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">10</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">X.test</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="fl">101</span>, <span class="no">p</span>)
<span class="no">X.test</span>[, <span class="fl">1</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(-<span class="fl">2</span>, <span class="fl">2</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">101</span>)

<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="fl">0.4</span> + <span class="fl">0.2</span> * (<span class="no">X</span>[, <span class="fl">1</span>] <span class="kw">&gt;</span> <span class="fl">0</span>))
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">X</span>[, <span class="fl">1</span>], <span class="fl">0</span>) * <span class="no">W</span> + <span class="no">X</span>[, <span class="fl">2</span>] + <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span>(<span class="no">X</span>[, <span class="fl">3</span>], <span class="fl">0</span>) + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)
<span class="no">tau.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>)
<span class="no">tau.forest</span>
<span class="co">#&gt; GRF forest object of type causal_forest </span>
<span class="co">#&gt; Number of trees: 2000 </span>
<span class="co">#&gt; Number of training samples: 2000 </span>
<span class="co">#&gt; Variable importance: </span>
<span class="co">#&gt;     1     2     3     4     5     6     7     8     9    10 </span>
<span class="co">#&gt; 0.691 0.033 0.041 0.046 0.029 0.029 0.034 0.027 0.033 0.037</span></pre></body></html></div>
<p>Estimate treatment effects for the training data using out-of-bag prediction.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">tau.hat.oob</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tau.forest</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="no">tau.hat.oob</span>$<span class="no">predictions</span>)</pre></body></html></div>
<p><img src="grf_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Estimate treatment effects for the test sample.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">tau.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tau.forest</span>, <span class="no">X.test</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>], <span class="no">tau.hat</span>$<span class="no">predictions</span>, <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">tau.hat</span>$<span class="no">predictions</span>, <span class="fl">0</span>, <span class="fl">2</span>), <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"x"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"tau"</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="fl">0</span>, <span class="no">X.test</span>[, <span class="fl">1</span>]), <span class="kw">col</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="grf_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Estimate the conditional average treatment effect on the full sample (CATE).</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">tau.forest</span>, <span class="kw">target.sample</span> <span class="kw">=</span> <span class="st">"all"</span>)
<span class="co">#&gt;   estimate    std.err </span>
<span class="co">#&gt; 0.37345648 0.04978157</span></pre></body></html></div>
<p>Estimate the conditional average treatment effect on the treated sample (CATT).</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/average_treatment_effect.html">average_treatment_effect</a></span>(<span class="no">tau.forest</span>, <span class="kw">target.sample</span> <span class="kw">=</span> <span class="st">"treated"</span>)
<span class="co">#&gt;   estimate    std.err </span>
<span class="co">#&gt; 0.47136673 0.05136118</span></pre></body></html></div>
<p>Add confidence intervals for heterogeneous treatment effects; growing more trees is now recommended.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">tau.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="no">W</span>, <span class="kw">num.trees</span> <span class="kw">=</span> <span class="fl">4000</span>)
<span class="no">tau.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">tau.forest</span>, <span class="no">X.test</span>, <span class="kw">estimate.variance</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">sigma.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">tau.hat</span>$<span class="no">variance.estimates</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>], <span class="no">tau.hat</span>$<span class="no">predictions</span>, <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span>(<span class="no">tau.hat</span>$<span class="no">predictions</span> + <span class="fl">1.96</span> * <span class="no">sigma.hat</span>, <span class="no">tau.hat</span>$<span class="no">predictions</span> - <span class="fl">1.96</span> * <span class="no">sigma.hat</span>, <span class="fl">0</span>, <span class="fl">2</span>), <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"x"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"tau"</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>], <span class="no">tau.hat</span>$<span class="no">predictions</span> + <span class="fl">1.96</span> * <span class="no">sigma.hat</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>], <span class="no">tau.hat</span>$<span class="no">predictions</span> - <span class="fl">1.96</span> * <span class="no">sigma.hat</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="no">X.test</span>[, <span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="fl">0</span>, <span class="no">X.test</span>[, <span class="fl">1</span>]), <span class="kw">col</span> <span class="kw">=</span> <span class="fl">2</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">1</span>)</pre></body></html></div>
<p><img src="grf_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>In some examples, pre-fitting models for Y and W separately may be helpful (e.g., if different models use different covariates). In some applications, one may even want to get Y.hat and W.hat using a completely different method (e.g., boosting).</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Generate new data.</span>
<span class="no">n</span> <span class="kw">&lt;-</span> <span class="fl">4000</span>
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fl">20</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span> * <span class="no">p</span>), <span class="no">n</span>, <span class="no">p</span>)
<span class="no">TAU</span> <span class="kw">&lt;-</span> <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">X</span>[, <span class="fl">3</span>]))
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="no">n</span>, <span class="fl">1</span>, <span class="fl">1</span> / (<span class="fl">1</span> + <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">X</span>[, <span class="fl">1</span>] - <span class="no">X</span>[, <span class="fl">2</span>])))
<span class="no">Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span>(<span class="no">X</span>[, <span class="fl">2</span>] + <span class="no">X</span>[, <span class="fl">3</span>], <span class="fl">0</span>) + <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowMeans</a></span>(<span class="no">X</span>[, <span class="fl">4</span>:<span class="fl">6</span>]) / <span class="fl">2</span> + <span class="no">W</span> * <span class="no">TAU</span> + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">n</span>)

<span class="no">forest.W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/regression_forest.html">regression_forest</a></span>(<span class="no">X</span>, <span class="no">W</span>, <span class="kw">tune.parameters</span> <span class="kw">=</span> <span class="st">"all"</span>)
<span class="no">W.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">forest.W</span>)$<span class="no">predictions</span>

<span class="no">forest.Y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/regression_forest.html">regression_forest</a></span>(<span class="no">X</span>, <span class="no">Y</span>, <span class="kw">tune.parameters</span> <span class="kw">=</span> <span class="st">"all"</span>)
<span class="no">Y.hat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">forest.Y</span>)$<span class="no">predictions</span>

<span class="no">forest.Y.varimp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/variable_importance.html">variable_importance</a></span>(<span class="no">forest.Y</span>)

<span class="co"># Note: Forests may have a hard time when trained on very few variables</span>
<span class="co"># (e.g., ncol(X) = 1, 2, or 3). We recommend not being too aggressive</span>
<span class="co"># in selection.</span>
<span class="no">selected.vars</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">forest.Y.varimp</span> / <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">forest.Y.varimp</span>) <span class="kw">&gt;</span> <span class="fl">0.2</span>)

<span class="no">tau.forest</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/causal_forest.html">causal_forest</a></span>(<span class="no">X</span>[, <span class="no">selected.vars</span>], <span class="no">Y</span>, <span class="no">W</span>,
                            <span class="kw">W.hat</span> <span class="kw">=</span> <span class="no">W.hat</span>, <span class="kw">Y.hat</span> <span class="kw">=</span> <span class="no">Y.hat</span>,
                            <span class="kw">tune.parameters</span> <span class="kw">=</span> <span class="st">"all"</span>)</pre></body></html></div>
<p>Check whether causal forest predictions are well calibrated.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="../reference/test_calibration.html">test_calibration</a></span>(<span class="no">tau.forest</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Best linear fit using forest predictions (on held-out data)</span>
<span class="co">#&gt; as well as the mean forest prediction as regressors, along</span>
<span class="co">#&gt; with one-sided heteroskedasticity-robust (HC3) SEs:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                                Estimate Std. Error t value    Pr(&gt;t)    </span>
<span class="co">#&gt; mean.forest.prediction         1.019163   0.075473 13.5037 &lt; 2.2e-16 ***</span>
<span class="co">#&gt; differential.forest.prediction 0.694064   0.170967  4.0596 2.505e-05 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></pre></body></html></div>
<p>For more worked examples see the <em>Tutorials</em> section.</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Julie Tibshirani, Susan Athey, Erik Sverdrup, Stefan Wager.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
